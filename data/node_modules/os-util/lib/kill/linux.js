const {spawn} = require('child_process');
const util = require('wangct-server-util');

module.exports = {
  getPidByPort,
  kill,
  killByPort,
};

/**
 * 根据端口号获取进程id
 * @param port
 * @returns {Promise<*>}
 */
async function getPidByPort(port){
  const cp = spawn('lsof',['-i:' + port]);
  const body = await util.getReqBody(cp.stdout);
  const content = body.toString().replace(/^[\r\n\s]+|[\r\n\s]$/g,'');
  const line = content.split('\n')[1];
  let pid;
  console.log(line,content);
  if(line){
    pid = line.trim().split(/\s+/)[1];
  }
  return pid;
}

/**
 * 杀死进程
 * @param pid
 * @returns {Promise<unknown>}
 */
async function kill(pid){
  return new Promise((cb,eb) => {
    const cp = spawn('kill',[pid],{
      stdout:'inherit',
    });
    cp.on('close',(e) => {
      cb(e);
    });
  })
}

/**
 * 根据端口号杀死进程
 * @param port
 * @returns {Promise<void>}
 */
async function killByPort(port){
  const pid = await getPidByPort(port);
  await kill(pid);
}
