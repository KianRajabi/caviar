const {spawn} = require('child_process');
const util = require('wangct-server-util');


module.exports = {
  getPidByPort,
  kill,
  killByPort,
};

/**
 * 根据端口号获取进程id
 * @param port
 * @returns {Promise<*>}
 */
async function getPidByPort(port){
  const cp = spawn('netstat',['-ano']);
  const body = await util.getReqBody(cp.stdout);
  const content = body.toString();
  const list = content.split('\r\n');
  let pid;
  list.forEach((item) => {
    const ary = item.trim().split(/\s+/);
    if(ary[1] && ary[1].split(':')[1] === port + ''){
      pid = ary[ary.length - 1];
    }
  });
  return pid;
}

/**
 * 杀死进程
 * @param pid
 * @returns {Promise<unknown>}
 */
async function kill(pid){
  return new Promise((cb,eb) => {
    const cp = spawn('taskkill',['/F','/pid',pid],{
      stdout:'inherit',
    });
    cp.on('close',(e) => {
      cb(e);
    });
  })
}

/**
 * 根据端口号杀死进程
 * @param port
 * @returns {Promise<void>}
 */
async function killByPort(port){
  const pid = await getPidByPort(port);
  await kill(pid);
}
